<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Worker Registration | KaryaNet</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
  body{min-height:100vh;background:#f4f4f4;display:flex;justify-content:center;align-items:center;}
  .container{background:white;padding:2rem;border-radius:16px;box-shadow:0 8px 20px rgba(0,0,0,0.15);width:400px;}
  h2{text-align:center;margin-bottom:1rem;color:#2E4600;}
  form{display:flex;flex-direction:column;gap:0.8rem;}
  input, select, textarea{padding:0.6rem;border:1px solid #6B8E23;border-radius:8px;outline:none;font-size:1rem;}
  button{padding:0.7rem;background:#6B8E23;color:white;border:none;border-radius:8px;font-weight:500;cursor:pointer;transition:0.3s;font-size:1rem;}
  button:hover{background:#2E4600;}
</style>
</head>
<body>

<div class="container">
  <h2>Complete Worker Registration</h2>
  <form id="workerForm">
    <input type="text" id="serviceName" placeholder="Service Name" required>
    <textarea id="description" placeholder="Description" rows="3" required></textarea>
    <input type="text" id="category" placeholder="Category" required>
    <input type="text" id="providerName" placeholder="Your Name" required>
    <input type="text" id="providerVillage" placeholder="Village/City" required>
    <input type="text" id="providerContact" placeholder="Contact Number" required>
    <select id="gender" required>
      <option value="">Select Gender</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
      <option value="Other">Other</option>
    </select>
    <input type="text" id="image" placeholder="Profile Image URL (optional)">
    <button type="submit">Register as Worker</button>
  </form>
</div>

<script>
const workerForm = document.getElementById("workerForm");

workerForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const user = JSON.parse(localStorage.getItem("user"));
  if(!user || user.role !== "worker"){
    alert("Invalid user. Please login as worker first.");
    window.location.href = "login.html";
    return;
  }

  const payload = {
    name: document.getElementById("serviceName").value.trim(),
    description: document.getElementById("description").value.trim(),
    category: document.getElementById("category").value.trim(),
    provider_name: document.getElementById("providerName").value.trim(),
    provider_village: document.getElementById("providerVillage").value.trim(),
    provider_contact: document.getElementById("providerContact").value.trim(),
    gender: document.getElementById("gender").value,
    image: document.getElementById("image").value.trim(),
    rating: 0,
    reviews: 0,
    available: true,
    user_id: parseInt(user.user_id)   // Add this if backend expects
  };

  try{
    const res = await fetch("http://127.0.0.1:8000/worker", {  // make sure endpoint matches backend
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (res.ok) {
    alert("Worker registration successful!");
    window.location.href = "worker-dashboard.html";
  } else {
    console.error("Error:", data);
    // Try to extract the most useful error message
    const errorMsg =
      (typeof data.detail === "string"
        ? data.detail
        : JSON.stringify(data.detail || data));
    alert("Registration failed: " + errorMsg);
  }
  } catch(err){
    console.error(err);
    alert("Cannot connect to backend. Make sure FastAPI server is running.");
  }
});
</script>

</body>
</html>
