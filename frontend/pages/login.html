<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KaryaNet | Login/Register</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
body{
  min-height:100vh;
  background: linear-gradient(to bottom right, rgba(58,125,68,0.75), rgba(84,153,55,0.7)),
              url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1350&q=80') no-repeat center center/cover;
  position: relative;
}

/* Header */
header{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  z-index:100;
  padding:1rem 2rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
  backdrop-filter: blur(5px);
}
header .logo a{
  font-size:2rem;
  font-weight:bold;
  text-decoration:none;
  color:white;
  cursor:pointer;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
}
nav ul{
  display:flex;
  gap:1.5rem;
  list-style:none;
  font-weight:500;
}
nav ul li a{
  text-decoration:none;
  color:white;
  padding:0.7rem 1.2rem;
  border-radius:8px;
  transition:0.3s;
  font-size:1.2rem;
  font-weight:bold;
}
nav ul li a:hover{
  background:#2E4600;
  color:white;
}
.hamburger{
  display:none;
  flex-direction:column;
  cursor:pointer;
  gap:5px;
}
.hamburger span{
  width:25px;
  height:3px;
  background:#2E4600;
  border-radius:2px;
}

/* Responsive Header */
@media(max-width:500px){
  .hamburger{display:flex;}
  nav ul{
    display:none;
    position:absolute;
    top:65px;
    right:2rem;
    flex-direction:column;
    width:180px;
    padding:0.5rem 0;
    border-radius:8px;
    transition:0.3s ease-in-out;
    background: rgba(46,70,0,0.85);
  }
  nav ul.show{display:flex;}
}

/* Login/Register Card */
.container-login{
  background: rgba(255,255,255,0.95);
  padding:2rem;
  border-radius:16px;
  box-shadow:0 8px 20px rgba(0,0,0,0.15);
  width:380px;
  max-width:90%;
  position:relative;
  overflow:hidden;
  margin:150px auto 50px auto;
  border:2px solid rgba(46,70,0,0.5);
}
.tabs{
  display:flex;
  margin-bottom:1.5rem;
  border-radius:12px;
  overflow:hidden;
}
.tabs button{
  flex:1;
  padding:0.8rem;
  background:#79b448;
  border:none;
  cursor:pointer;
  font-weight:600;
  color:#fff;
  transition:0.2s;
  font-size:1rem;
}
.tabs button.active{background:#2E4600;color:white;}
form{display:flex;flex-direction:column;gap:0.8rem;}
form input, form select{
  padding:0.6rem;
  border:1px solid #6B8E23;
  border-radius:8px;
  outline:none;
  font-size:1rem;
}
form button{
  padding:0.7rem;
  background:#6B8E23;
  color:white;
  border:none;
  border-radius:8px;
  font-weight:500;
  cursor:pointer;
  transition:0.3s;
  font-size:1rem;
}
form button:hover{background:#2E4600;}
.toggle-msg{
  text-align:center;
  color:#2E4600;
  font-size:1rem;
  margin-top:0.5rem;
  cursor:pointer;
}
.toggle-msg span{color:#79b448;}
</style>
</head>
<body>

<!-- Header -->
<header>
  <div class="logo"><a href="../index.html">KaryaNet</a></div>
  <nav>
    <ul class="nav-links">
      <li><a href="../index.html">Home</a></li>
      <li><a href="./services.html">Services</a></li>
    </ul>
    <div class="hamburger">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </nav>
</header>

<!-- Login/Register Card -->
<div class="container-login">
  <div class="tabs">
    <button id="loginTab" class="active">Login</button>
    <button id="registerTab">Register</button>
  </div>

  <!-- Login Form -->
  <form id="loginForm">
    <input type="email" id="loginEmail" placeholder="Email" required>
    <input type="password" id="loginPassword" placeholder="Password" required>
    <button type="submit">Login</button>
    <div class="toggle-msg">Don't have an account? <span id="showRegister">Register</span></div>
  </form>

  <!-- Register Form -->
  <form id="registerForm" style="display:none;">
    <input type="text" id="regName" placeholder="Full Name" required>
    <input type="email" id="regEmail" placeholder="Email" required>
    <input type="password" id="regPassword" placeholder="Password" required>
    <input type="password" id="regConfirm" placeholder="Confirm Password" required>

    <label for="regRole">I want to:</label>
    <select id="regRole">
      <option value="customer">Request Services (Customer)</option>
      <option value="worker">Provide Services (Worker)</option>
    </select>

    <button type="submit">Register</button>
    <div class="toggle-msg">Already have an account? <span id="showLogin">Login</span></div>
  </form>
</div>

<script>
// Responsive Nav
const hamburger = document.querySelector(".hamburger");
const navLinks = document.querySelector("nav ul");
hamburger.addEventListener("click", () => navLinks.classList.toggle("show"));
document.addEventListener("click", (e) => {
  if(!e.target.closest("header")) navLinks.classList.remove("show");
});

// Tabs
const loginTab = document.getElementById("loginTab");
const registerTab = document.getElementById("registerTab");
const loginForm = document.getElementById("loginForm");
const registerForm = document.getElementById("registerForm");
document.getElementById("showRegister").onclick = () => registerTab.click();
document.getElementById("showLogin").onclick = () => loginTab.click();

loginTab.onclick = () => {
  loginTab.classList.add("active");
  registerTab.classList.remove("active");
  loginForm.style.display = "flex";
  registerForm.style.display = "none";
};
registerTab.onclick = () => {
  registerTab.classList.add("active");
  loginTab.classList.remove("active");
  registerForm.style.display = "flex";
  loginForm.style.display = "none";
};

// API base URL
const API_BASE = "http://127.0.0.1:8000";

// LOGIN
loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const email = loginEmail.value.trim();
  const password = loginPassword.value.trim();
  if(!email || !password){ alert("Please fill all fields"); return; }

  try {
    const res = await fetch(`${API_BASE}/login`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ email, password })
    });
    const data = await res.json();

    if(res.ok){
      const user = {
        user_id: data.user_id,
        name: data.name,
        email,
        role: data.role,
        contact: data.contact || "",
        location: data.location || "",
        gender: data.gender || ""
      };
      localStorage.setItem("user", JSON.stringify(user));
      alert("Login successful!");

      // âœ… Redirect back to previous page if available
      const redirectTo = localStorage.getItem("redirectAfterLogin");
      if (redirectTo) {
        localStorage.removeItem("redirectAfterLogin");
        window.location.href = redirectTo;
      } else {
        // Default redirection based on role
        if(user.role === "customer") window.location.href = "customer-dashboard.html";
        else if(user.role === "worker") window.location.href = "worker-dashboard.html";
        else window.location.href = "services.html";
      }
    } else {
      alert(data.detail || "Invalid credentials");
    }
  } catch (err) {
    console.error(err);
    alert("Cannot connect to backend. Please ensure FastAPI is running.");
  }
});

// REGISTER
registerForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const name = regName.value.trim();
  const email = regEmail.value.trim();
  const password = regPassword.value;
  const confirm = regConfirm.value;
  const role = regRole.value;

  if(!name || !email || !password || !confirm){
    alert("Please fill all fields");
    return;
  }
  if(password !== confirm){
    alert("Passwords do not match!");
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/register`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ name, email, password, role })
    });
    const data = await res.json();

    if(res.ok){
      alert(data.message || "Registration successful!");
      const user = { user_id: data.user_id, name, email, role };
      localStorage.setItem("user", JSON.stringify(user));

      if(role === "worker") window.location.href = "worker-register.html";
      else window.location.href = "customer-dashboard.html";
    } else {
      alert(data.detail || "Registration failed.");
    }
  } catch (err) {
    console.error(err);
    alert("Cannot connect to backend. Please ensure FastAPI is running.");
  }
});
</script>
</body>
</html>
